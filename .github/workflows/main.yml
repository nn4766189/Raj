name: CI Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: python:3.9

    steps:
      - name: Checkout code
        uses: actions/checkout@v3  # Updated to the latest version

      - name: Cache Python packages
        uses: actions/cache@v3  # Updated to the latest version
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          set -e  # Exit on error
          pip install -r requirements.txt

      - name: Run setup script
        run: |
          echo 'Setting up environment...'
          echo 'Environment setup complete.'

      - name: Compile C++ and run Python script
        run: |
          set -e  # Exit on error
          g++ -o raja loda.cpp -std=c++11 -pthread || { echo 'Compilation failed'; exit 1; }
          chmod +x raja
          echo 'Running the script...'
          python soul.py || { echo 'Python script execution failed'; exit 1; }

      - name: Restart pipeline (optional)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Sleeping for 1 hour before restarting..."
          sleep 3600
          echo "Restarting the pipeline..."
          curl -X POST \
            -F token=${{ secrets.GITHUB_TOKEN }} \
            -F ref=main \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/main.yml/dispatches || { echo 'Failed to restart pipeline'; exit 1; }
